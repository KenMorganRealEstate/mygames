<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MORGAN'S FURY 2112</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@900&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            margin: 0; overflow: hidden; background-color: #000;
            font-family: 'Orbitron', sans-serif;
            touch-action: none; /* CRITICAL: Disables browser zooming/panning */
            user-select: none; -webkit-user-select: none;
            overscroll-behavior: none;
        }
        canvas { display: block; }

        /* --- BACKGROUNDS --- */
        .bg-cover-art {
            background-image: url('https://kenmorganrealestate.github.io/mygames/2112.jpg?v=999');
            background-size: cover; background-position: center; background-repeat: no-repeat; background-color: #000;
        }
        .bg-game-over {
            background-image: url('https://kenmorganrealestate.github.io/mygames/chromey.jpg?v=999');
            background-size: cover; background-position: center; background-repeat: no-repeat;
        }
        .bg-deep-space { background-color: #000000; }

        /* --- UI STYLES --- */
        .title-font { font-family: 'Cinzel Decorative', cursive; font-weight: 900; color: #bf0000; text-shadow: 0 0 5px #fff, 0 0 10px #bf0000; }
        .ui-font { font-family: 'Orbitron', sans-serif; }
        
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10;
        }
        .interactive { pointer-events: auto; }
        .hidden { display: none !important; }

        .rush-box {
            background: rgba(0, 0, 0, 0.85); border: 2px solid #bf0000; box-shadow: 0 0 20px rgba(191, 0, 0, 0.4);
            padding: 25px; border-radius: 4px; text-align: center; max-width: 90%; position: relative; z-index: 20;
        }
        .rush-button {
            background: transparent; color: #bf0000; border: 2px solid #bf0000; padding: 15px 30px;
            font-size: 1.2rem; font-weight: bold; cursor: pointer; text-transform: uppercase;
            box-shadow: 0 0 10px #bf0000; transition: all 0.2s; font-family: 'Orbitron', sans-serif; margin-top: 10px;
        }
        .rush-button:active { background: #bf0000; color: #000; }
        .rush-input { background: rgba(0,0,0,0.7); border: 1px solid #fff; color: #fff; padding: 10px; text-align: center; font-size: 1.2rem; outline: none; }

        /* --- DRAGGABLE BUTTONS --- */
        .drag-btn {
            position: absolute;
            width: 75px; height: 75px;
            border-radius: 50%;
            background: rgba(60, 60, 60, 0.4);
            border: 2px solid #fff;
            color: #fff;
            font-size: 1.8rem;
            display: flex; justify-content: center; align-items: center;
            user-select: none; -webkit-user-select: none;
            touch-action: none;
            backdrop-filter: blur(2px);
            z-index: 9999; /* TOP LAYER */
            pointer-events: auto; /* MUST BE AUTO */
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        
        /* Visual Feedback when Pressed */
        .drag-btn.pressed {
            background-color: rgba(255, 0, 0, 0.8) !important;
            border-color: #ff0000 !important;
            transform: scale(0.95);
            box-shadow: 0 0 20px #ff0000;
        }

        /* Edit Mode Styles */
        .edit-mode .drag-btn {
            border-color: #00ff00;
            border-style: dashed;
            background: rgba(0, 255, 0, 0.2);
            animation: pulse-border 1s infinite;
            cursor: grab;
        }
        @keyframes pulse-border {
            0% { border-color: #00ff00; } 50% { border-color: #fff; } 100% { border-color: #00ff00; }
        }

        /* --- SWITCHES --- */
        .toggle-row { display: flex; justify-content: space-between; width: 100%; margin-bottom: 12px; align-items: center; }
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; transform: skew(-10deg); border: 1px solid #555; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: #888; transition: .4s; }
        input:checked + .slider { background-color: #000; border-color: #bf0000; }
        input:checked + .slider:before { transform: translateX(26px); background-color: #bf0000; }

        /* HUD */
        #score-hud, #lives-hud, #level-hud { position: absolute; top: 20px; color: #bf0000; font-size: 20px; font-weight: bold; text-shadow: 0 0 5px #bf0000; pointer-events: none; z-index: 50; }
        #score-hud { left: 20px; }
        #lives-hud { right: 20px; }
        #level-hud { left: 50%; transform: translateX(-50%); }

        /* FX */
        #crt-layer { pointer-events: none; }
        #sparks-container { position: absolute; width: 100%; height: 100%; pointer-events: none; overflow: hidden; }
        .spark { position: absolute; width: 5px; height: 5px; background: orange; border-radius: 50%; animation: floatUp 2s linear forwards; }
        @keyframes floatUp { to { transform: translateY(-100vh); opacity: 0; } }
    </style>
</head>
<body class="bg-cover-art" id="main-body"> 

    <div id="crt-layer" class="crt-overlay"></div>
    <div id="sparks-container"></div>

    <div id="audio-wall" class="ui-layer interactive" style="z-index: 100;">
        <h1 class="title-font text-4xl mb-4 text-center">MORGAN'S FURY 2112</h1>
        <button id="init-audio-btn" class="rush-button">ENGAGE SYSTEMS</button>
    </div>

    <div id="score-hud" class="ui-font hidden">SCORE: <span id="score-val">0</span></div>
    <div id="level-hud" class="ui-font hidden">LEVEL: <span id="level-val">1</span></div>
    <div id="lives-hud" class="ui-font hidden">LIVES: <span id="lives-val">3</span></div>

    <div id="touch-interface" class="hidden" style="position: absolute; width: 100%; height: 100%; top: 0; left: 0; z-index: 9000; pointer-events: none;">
        
        <div id="btn-left" class="drag-btn" style="bottom: 120px; left: 20px;">
            <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
        </div>
        
        <div id="btn-right" class="drag-btn" style="bottom: 120px; left: 110px;">
            <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M21 12a9 9 0 1 1-9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
        </div>
        
        <div id="btn-thrust" class="drag-btn" style="bottom: 30px; left: 65px; width: 85px; height: 85px; border-color: #fff;">ðŸš€</div>
        
        <div id="btn-fire" class="drag-btn" style="bottom: 40px; right: 30px; width: 90px; height: 90px; border-color: #ff4444; color: #ff4444;">ðŸ”¥</div>
        
        <div id="btn-hyperspace" class="drag-btn" style="bottom: 150px; right: 40px; border-color: #a0a0ff; color: #a0a0ff;">âš¡</div>
        
        <div id="btn-pause" class="drag-btn" style="top: 20px; left: 20px; width: 50px; height: 50px; font-size: 1rem;">II</div>
        
        <div id="btn-music" class="drag-btn" style="top: 20px; right: 20px; width: 50px; height: 50px; font-size: 1rem;">â™«</div>
    </div>

    <div id="start-screen" class="ui-layer interactive hidden" style="z-index: 50;">
        <div class="rush-box w-96">
            <h1 class="title-font text-4xl mb-2">MORGAN'S FURY 2112</h1>
            <p class="text-gray-400 ui-font text-xs mb-6">DEV: KEN MORGAN</p>
            
            <div class="bg-black/80 p-4 rounded border border-gray-700 mb-6 w-full text-left">
                <h3 class="text-red-500 font-bold mb-3 border-b border-gray-700 pb-1 text-sm text-center">CONTROLS SETUP</h3>
                <div class="toggle-row">
                    <span class="text-xs text-gray-300">ENABLE TOUCH BUTTONS</span>
                    <label class="switch"><input type="checkbox" id="touch-toggle"><span class="slider"></span></label>
                </div>
                <div class="toggle-row">
                    <span class="text-xs text-yellow-500 font-bold">CUSTOMIZE LAYOUT (DRAG)</span>
                    <label class="switch"><input type="checkbox" id="edit-toggle"><span class="slider"></span></label>
                </div>
                <p class="text-xs text-gray-500 italic text-center mt-2">*Turn Customize OFF to Play</p>
            </div>
            
            <button id="start-btn" class="rush-button w-full">INITIALIZE MISSION</button>

            <div class="mt-4 border-t border-red-900 pt-2">
                <h3 class="text-red-500 font-bold text-xs">HALL OF FAME</h3>
                <table id="highscore-list" class="w-full text-xs text-gray-400"></table>
            </div>
        </div>
    </div>

    <div id="game-over-screen" class="ui-layer interactive hidden" style="z-index: 50;">
        <div class="rush-box">
            <h1 class="title-font text-5xl mb-4 text-white">MISSION FAILED</h1>
            <p class="text-red-500 text-2xl mb-6 ui-font">SCORE: <span id="final-score">0</span></p>
            <input type="text" id="player-name" class="rush-input" placeholder="PILOT NAME" maxlength="10">
            <br>
            <button id="save-score-btn" class="rush-button text-sm mt-4">SAVE RECORD</button>
            <div class="mt-4 flex gap-2 justify-center">
                <button id="restart-btn" class="rush-button text-sm">RETRY</button>
                <button id="return-menu-btn" class="rush-button text-sm">MENU</button>
            </div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
/**
 * MORGAN'S FURY 2112 - FIXED CONTROLS
 */

// --- GLOBAL VARIABLES ---
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const STORAGE_KEY = 'morgans_fury_scores';

// State Flags
let gameState = 'INIT_WAIT';
let isPaused = false;
let isEditMode = false; // Controls Drag vs Click

// Game Data
let score = 0;
let lives = 3;
let level = 1;
let saucersSpawnedCount = 0;
let saucer = null;
let saucerTimer = 0;

// Inputs
const keys = { 
    ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false, 
    Control: false, Alt: false, Shift: false, ' ': false 
};

// Entities
let player;
let projectiles = [];
let enemyProjectiles = [];
let asteroids = [];
let particles = [];
let stars = [];
let floatingTexts = [];

// --- CLASSES ---

class FloatingText {
    constructor(x, y, text, color = '#fff') {
        this.x = x; this.y = y; this.text = text; this.color = color;
        this.life = 60; this.vy = -1;
    }
    update() { this.y += this.vy; this.life--; }
    draw() {
        ctx.save(); ctx.globalAlpha = Math.min(1, this.life/20);
        ctx.fillStyle = this.color; ctx.font = 'bold 20px Orbitron';
        ctx.fillText(this.text, this.x, this.y); ctx.restore();
    }
}

class Star {
    constructor(mode = 'static') { this.init(mode); }
    init(mode) {
        this.x = Math.random() * canvas.width;
        this.y = Math.random() * canvas.height;
        this.size = Math.random() * 2;
        this.alpha = Math.random();
        this.speed = (mode === 'warp') ? 15 : 0;
    }
    update() {
        if(this.speed > 0) {
            this.x -= this.speed;
            if(this.x < 0) this.x = canvas.width;
        }
    }
    draw() {
        ctx.fillStyle = `rgba(255,255,255,${this.alpha})`;
        ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill();
    }
}

class Player {
    constructor() {
        this.x = canvas.width/2; this.y = canvas.height/2;
        this.vx = 0; this.vy = 0;
        this.angle = -Math.PI/2;
        this.radius = 15;
        this.visible = true;
        this.thrusting = false;
    }
    update() {
        if(!this.visible) return;
        if(keys.Control) this.angle -= 0.08;
        if(keys.Alt) this.angle += 0.08;
        this.thrusting = keys.ArrowDown;
        
        if(this.thrusting) {
            this.vx += Math.cos(this.angle) * 0.15;
            this.vy += Math.sin(this.angle) * 0.15;
            if(Math.random()>0.5) particles.push(new Particle(this.x - Math.cos(this.angle)*15, this.y - Math.sin(this.angle)*15, '#ffaa00'));
            AudioEngine.startThrust();
        } else {
            AudioEngine.stopThrust();
        }
        this.vx *= 0.99; this.vy *= 0.99;
        this.x += this.vx; this.y += this.vy;
        if(this.x < -15) this.x = canvas.width+15; if(this.x > canvas.width+15) this.x = -15;
        if(this.y < -15) this.y = canvas.height+15; if(this.y > canvas.height+15) this.y = -15;
    }
    draw() {
        if(!this.visible) return;
        ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.angle);
        ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.fillStyle = '#000';
        ctx.beginPath(); ctx.moveTo(20,0); ctx.lineTo(-15, 12); ctx.lineTo(-10,0); ctx.lineTo(-15,-12); ctx.closePath();
        ctx.fill(); ctx.stroke();
        if(this.thrusting) {
            ctx.fillStyle = '#ffaa00';
            ctx.beginPath(); ctx.moveTo(-12,6); ctx.lineTo(-25 - Math.random()*5, 0); ctx.lineTo(-12,-6); ctx.fill();
        }
        ctx.restore();
    }
    shoot() {
        if(!this.visible) return;
        projectiles.push(new Projectile(this.x + Math.cos(this.angle)*20, this.y + Math.sin(this.angle)*20, this.angle));
        AudioEngine.shoot();
    }
    hyperspace() {
        this.x = Math.random() * canvas.width;
        this.y = Math.random() * canvas.height;
        this.vx = 0; this.vy = 0;
        AudioEngine.playWarp();
    }
}

class Projectile {
    constructor(x, y, angle, isEnemy=false) {
        this.x = x; this.y = y;
        this.speed = isEnemy ? 8 : 14;
        this.vx = Math.cos(angle) * this.speed;
        this.vy = Math.sin(angle) * this.speed;
        this.life = 60;
        this.color = isEnemy ? '#f00' : '#fff';
    }
    update() {
        this.x += this.vx; this.y += this.vy; this.life--;
        if(this.x < 0) this.x = canvas.width; if(this.x > canvas.width) this.x = 0;
        if(this.y < 0) this.y = canvas.height; if(this.y > canvas.height) this.y = 0;
    }
    draw() {
        ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, 2, 0, Math.PI*2); ctx.fill();
    }
}

class Saucer {
    constructor() {
        this.radius = 20;
        this.y = Math.random() * (canvas.height - 100) + 50;
        this.x = (Math.random() < 0.5) ? -30 : canvas.width + 30;
        this.vx = (this.x < 0) ? 2 + Math.random() : -2 - Math.random();
        this.vy = (Math.random()-0.5)*2;
        this.markedForDeletion = false;
        this.timer = 0;
        AudioEngine.saucerSpawn();
    }
    update() {
        this.x += this.vx; this.y += this.vy;
        this.timer++;
        if(this.timer > 100) {
            if(player && player.visible) {
                const angle = Math.atan2(player.y - this.y, player.x - this.x);
                enemyProjectiles.push(new Projectile(this.x, this.y, angle, true));
                AudioEngine.saucerFire();
            }
            this.timer = 0;
        }
        if((this.vx > 0 && this.x > canvas.width + 50) || (this.vx < 0 && this.x < -50)) {
            this.markedForDeletion = true;
            AudioEngine.stopSaucerSound();
        }
    }
    draw() {
        ctx.strokeStyle = '#f00'; ctx.lineWidth = 2;
        ctx.beginPath(); 
        ctx.moveTo(this.x-15, this.y); ctx.lineTo(this.x+15, this.y);
        ctx.moveTo(this.x-8, this.y-8); ctx.lineTo(this.x+8, this.y-8); ctx.lineTo(this.x+15, this.y);
        ctx.lineTo(this.x-15, this.y); ctx.lineTo(this.x-8, this.y-8);
        ctx.stroke();
    }
}

class Asteroid {
    constructor(x, y, size) {
        this.x = x; this.y = y; this.size = size; 
        this.radius = size * 15;
        const angle = Math.random() * Math.PI * 2;
        this.vx = Math.cos(angle) * (1 + Math.random());
        this.vy = Math.sin(angle) * (1 + Math.random());
        this.points = [];
        const v = 8 + Math.random() * 4;
        for(let i=0; i<v; i++) {
            this.points.push((this.radius * 0.7) + Math.random() * (this.radius * 0.3));
        }
    }
    update() {
        this.x += this.vx; this.y += this.vy;
        if(this.x < -50) this.x = canvas.width+50; if(this.x > canvas.width+50) this.x = -50;
        if(this.y < -50) this.y = canvas.height+50; if(this.y > canvas.height+50) this.y = -50;
    }
    draw() {
        ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.beginPath();
        for(let i=0; i<this.points.length; i++) {
            const a = (Math.PI*2 / this.points.length) * i;
            const r = this.points[i];
            const px = Math.cos(a)*r; const py = Math.sin(a)*r;
            if(i===0) ctx.moveTo(this.x+px, this.y+py); else ctx.lineTo(this.x+px, this.y+py);
        }
        ctx.closePath(); ctx.stroke();
    }
}

class Particle {
    constructor(x, y, color) {
        this.x = x; this.y = y; this.color = color;
        this.vx = (Math.random()-0.5)*4; this.vy = (Math.random()-0.5)*4;
        this.life = 1.0;
    }
    update() { this.x+=this.vx; this.y+=this.vy; this.life-=0.05; }
    draw() { ctx.globalAlpha = Math.max(0, this.life); ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, 2, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha = 1; }
}

// --- AUDIO SYSTEM (FULL RESTORATION) ---
const MusicManager = {
    menuTrack: new Audio('https://kenmorganrealestate.github.io/mygames/overture.mp3'),
    playlistUrls: [
        'https://kenmorganrealestate.github.io/mygames/limelight.mp3',
        'https://kenmorganrealestate.github.io/mygames/somethingfornothing.mp3',
        'https://kenmorganrealestate.github.io/mygames/stickitout.mp3',
        'https://kenmorganrealestate.github.io/mygames/syrnix.mp3',
        'https://kenmorganrealestate.github.io/mygames/twilightzone.mp3'
    ],
    outroTrack: new Audio('https://kenmorganrealestate.github.io/mygames/outro2112.mp3'),
    currentTrack: null,
    isPlayingGameMusic: false,
    volume: 0.3, 
    init() {
        this.menuTrack.loop = true;
        this.menuTrack.volume = this.volume;
    },
    playMenu() {
        this.stopGameMusic(); this.stopOutro();
        this.menuTrack.play().catch(e=>console.log(e));
    },
    stopMenu() { this.menuTrack.pause(); this.menuTrack.currentTime = 0; },
    playRandomGameTrack() {
        this.stopMenu();
        if(this.currentTrack) this.currentTrack.pause();
        const url = this.playlistUrls[Math.floor(Math.random()*this.playlistUrls.length)];
        this.currentTrack = new Audio(url);
        this.currentTrack.volume = this.volume;
        this.currentTrack.play().catch(e=>console.log(e));
        this.currentTrack.onended = () => this.playRandomGameTrack();
        
        // Show visual feedback
        const name = url.split('/').pop().replace('.mp3', '').toUpperCase();
        floatingTexts.push(new FloatingText(canvas.width/2, 50, "PLAYING: " + name, "#00ff00"));
    },
    stopGameMusic() { if(this.currentTrack) { this.currentTrack.pause(); } },
    playOutro() { this.stopGameMusic(); this.stopMenu(); this.outroTrack.play().catch(e=>console.log(e)); },
    stopOutro() { this.outroTrack.pause(); this.outroTrack.currentTime = 0; }
};

const AudioEngine = {
    ctx: null,
    rocketSound: new Audio('https://kenmorganrealestate.github.io/mygames/rocket.mp3'),
    saucerSound: new Audio('https://kenmorganrealestate.github.io/mygames/2112Ringtone.mp3'),
    init() { 
        this.ctx = new (window.AudioContext || window.webkitAudioContext)(); 
        this.rocketSound.loop = true; this.rocketSound.volume = 0.5;
        this.saucerSound.loop = true; this.saucerSound.volume = 0.6;
    },
    tone(freq, type, dur, vol=0.1) {
        if(!this.ctx) return;
        const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
        o.type = type; o.frequency.value = freq;
        o.connect(g); g.connect(this.ctx.destination);
        g.gain.setValueAtTime(vol, this.ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.0001, this.ctx.currentTime + dur);
        o.start(); o.stop(this.ctx.currentTime + dur);
    },
    shoot() { this.tone(880, 'sawtooth', 0.15); },
    explode() { 
        this.tone(100, 'square', 0.4, 0.3);
        this.tone(50, 'sawtooth', 0.4, 0.3);
    },
    playWarp() { 
        this.tone(500, 'sine', 0.5, 0.2); 
        this.tone(1500, 'sine', 0.5, 0.1); 
    },
    startThrust() { if(this.rocketSound.paused) this.rocketSound.play().catch(e=>{}); },
    stopThrust() { if(!this.rocketSound.paused) { this.rocketSound.pause(); this.rocketSound.currentTime=0; } },
    saucerSpawn() { this.saucerSound.play().catch(e=>{}); },
    stopSaucerSound() { this.saucerSound.pause(); this.saucerSound.currentTime=0; },
    saucerFire() { this.tone(1200, 'sine', 0.1, 0.2); }
};

// --- TOUCH INTERFACE LOGIC ---

const touchInterface = document.getElementById('touch-interface');
const touchToggle = document.getElementById('touch-toggle');
const editToggle = document.getElementById('edit-toggle');
const dragButtons = document.querySelectorAll('.drag-btn');

// 1. Dragging Logic (Edit Mode Only)
function setupDrag(el) {
    let offsetX, offsetY;
    el.addEventListener('pointerdown', (e) => {
        if(!isEditMode) return;
        el.setPointerCapture(e.pointerId);
        const rect = el.getBoundingClientRect();
        offsetX = e.clientX - rect.left;
        offsetY = e.clientY - rect.top;
        el.dataset.dragging = "true";
    });

    el.addEventListener('pointermove', (e) => {
        if(!isEditMode || el.dataset.dragging !== "true") return;
        el.style.left = (e.clientX - offsetX) + 'px';
        el.style.top = (e.clientY - offsetY) + 'px';
        el.style.bottom = 'auto'; el.style.right = 'auto';
    });

    el.addEventListener('pointerup', (e) => {
        el.dataset.dragging = "false";
        el.releasePointerCapture(e.pointerId);
    });
}

// 2. Game Action Logic (Play Mode Only)
function setupGameAction(id, keyMap) {
    const el = document.getElementById(id);
    
    const press = (e) => {
        if(isEditMode) return; // Ignore clicks in edit mode
        e.preventDefault(); 
        el.classList.add('pressed'); 
        
        if(keyMap === 'SHOOT') { if(player && !isPaused) player.shoot(); } 
        else if (keyMap === 'HYPERSPACE') { if(player && !isPaused) player.hyperspace(); } 
        else if (keyMap === 'PAUSE') { isPaused = !isPaused; } 
        else if (keyMap === 'MUSIC') { MusicManager.playRandomGameTrack(); } 
        else { keys[keyMap] = true; } 
    };

    const release = (e) => {
        if(isEditMode) return;
        e.preventDefault();
        el.classList.remove('pressed');
        if(['SHOOT','HYPERSPACE','PAUSE','MUSIC'].indexOf(keyMap) === -1) {
            keys[keyMap] = false;
        }
    };

    el.addEventListener('pointerdown', press);
    el.addEventListener('pointerup', release);
    el.addEventListener('pointerleave', release);
    el.addEventListener('pointercancel', release);
}

// Initialize Buttons
dragButtons.forEach(btn => setupDrag(btn));
setupGameAction('btn-left', 'Control');
setupGameAction('btn-right', 'Alt');
setupGameAction('btn-thrust', 'ArrowDown');
setupGameAction('btn-fire', 'SHOOT');
setupGameAction('btn-hyperspace', 'HYPERSPACE');
setupGameAction('btn-pause', 'PAUSE');
setupGameAction('btn-music', 'MUSIC');


// --- UI HANDLERS ---
touchToggle.addEventListener('change', (e) => {
    if(e.target.checked) touchInterface.classList.remove('hidden');
    else touchInterface.classList.add('hidden');
});

editToggle.addEventListener('change', (e) => {
    isEditMode = e.target.checked;
    if(isEditMode) touchInterface.classList.add('edit-mode');
    else touchInterface.classList.remove('edit-mode');
});

document.getElementById('init-audio-btn').addEventListener('click', () => {
    AudioEngine.init();
    MusicManager.init();
    MusicManager.playMenu();
    document.getElementById('audio-wall').classList.add('hidden');
    document.getElementById('start-screen').classList.remove('hidden');
    
    // Auto-detect mobile
    if(/Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || window.innerWidth < 1024) {
        touchToggle.checked = true;
        touchInterface.classList.remove('hidden');
    }
    
    resize();
    initStars('warp');
    loop();
});

document.getElementById('start-btn').addEventListener('click', startGame);
document.getElementById('restart-btn').addEventListener('click', startGame);
document.getElementById('return-menu-btn').addEventListener('click', () => {
    gameState = 'MENU';
    MusicManager.playMenu();
    document.getElementById('game-over-screen').classList.add('hidden');
    document.getElementById('start-screen').classList.remove('hidden');
    initStars('warp');
});

// --- CORE GAME LOOP ---
function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);

function initStars(mode) {
    stars = [];
    for(let i=0; i<100; i++) stars.push(new Star(mode));
}

function startGame() {
    gameState = 'PLAYING';
    isPaused = false;
    score = 0;
    lives = 3;
    level = 1;
    saucer = null;
    saucerTimer = 0;
    
    // FORCE EDIT MODE OFF WHEN STARTING GAME
    isEditMode = false;
    editToggle.checked = false;
    touchInterface.classList.remove('edit-mode');

    MusicManager.playRandomGameTrack();
    
    player = new Player();
    projectiles = [];
    enemyProjectiles = [];
    asteroids = [];
    particles = [];
    
    // Create initial asteroids
    for(let i=0; i<4; i++) {
        let x = Math.random()*canvas.width;
        let y = Math.random()*canvas.height;
        if(Math.hypot(x-player.x, y-player.y) > 200) asteroids.push(new Asteroid(x,y,3));
    }
    
    document.getElementById('start-screen').classList.add('hidden');
    document.getElementById('game-over-screen').classList.add('hidden');
    document.getElementById('score-hud').classList.remove('hidden');
    document.getElementById('lives-hud').classList.remove('hidden');
    document.getElementById('level-hud').classList.remove('hidden');
    
    initStars('static');
}

function loop() {
    requestAnimationFrame(loop);
    
    // Clear
    ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width, canvas.height);
    
    // Background Stars
    stars.forEach(s => { s.update(); s.draw(); });

    if(gameState === 'PLAYING' && !isPaused) {
        if(player) { player.update(); player.draw(); }
        
        // Saucer Logic
        if(!saucer) {
            saucerTimer++;
            if(saucerTimer > 500 - (level*10)) {
                saucer = new Saucer();
                saucerTimer = 0;
            }
        } else {
            saucer.update(); saucer.draw();
            if(saucer.markedForDeletion) saucer = null;
            // Player hit Saucer
            if(saucer && player.visible && Math.hypot(player.x-saucer.x, player.y-saucer.y) < 30) {
                player.visible = false; lives--; AudioEngine.explode();
                saucer = null;
                checkGameOver();
            }
        }

        // Projectiles
        projectiles.forEach((p,i) => {
            p.update(); p.draw();
            if(p.life<=0) projectiles.splice(i,1);
        });

        enemyProjectiles.forEach((p,i) => {
            p.update(); p.draw();
            if(p.life<=0) enemyProjectiles.splice(i,1);
            if(player.visible && Math.hypot(p.x-player.x, p.y-player.y) < 15) {
                player.visible = false; lives--; AudioEngine.explode();
                enemyProjectiles.splice(i,1);
                checkGameOver();
            }
        });

        asteroids.forEach((a,ai) => {
            a.update(); a.draw();
            
            // Hit by Bullet
            projectiles.forEach((p,pi) => {
                if(Math.hypot(p.x-a.x, p.y-a.y) < a.radius) {
                    AudioEngine.explode();
                    score += 100;
                    projectiles.splice(pi,1);
                    asteroids.splice(ai,1);
                    // Debris
                    for(let k=0; k<5; k++) particles.push(new Particle(a.x, a.y, '#fff'));
                    // Split
                    if(a.size > 1) {
                        asteroids.push(new Asteroid(a.x, a.y, a.size-1));
                        asteroids.push(new Asteroid(a.x, a.y, a.size-1));
                    }
                }
            });
            
            // Saucer hit Asteroid
            if(saucer && Math.hypot(saucer.x-a.x, saucer.y-a.y) < a.radius + 15) {
                 saucer = null; AudioEngine.explode();
                 asteroids.splice(ai,1);
            }

            // Hit Player
            if(player.visible && Math.hypot(player.x-a.x, player.y-a.y) < player.radius + a.radius) {
                AudioEngine.explode();
                player.visible = false;
                lives--;
                // Sparks on death
                for(let k=0; k<20; k++) particles.push(new Particle(player.x, player.y, '#ff4444'));
                checkGameOver();
            }
        });
        
        particles.forEach((p,i) => {
            p.update(); p.draw();
            if(p.life<=0) particles.splice(i,1);
        });
        
        floatingTexts.forEach((f,i) => {
            f.update(); f.draw();
            if(f.life<=0) floatingTexts.splice(i,1);
        });

        // Level clear check
        if(asteroids.length === 0 && !saucer && gameState === 'PLAYING') {
            level++;
            score += 1000;
            // Add more asteroids
            for(let i=0; i<3+level; i++) asteroids.push(new Asteroid(Math.random()*canvas.width, Math.random()*canvas.height, 3));
        }

        // HUD Update
        document.getElementById('score-val').innerText = score;
        document.getElementById('lives-val').innerText = lives;
        document.getElementById('level-val').innerText = level;
    }
}

function checkGameOver() {
    if(lives < 0) {
        gameState = 'GAMEOVER';
        MusicManager.playOutro();
        document.getElementById('final-score').innerText = score;
        document.getElementById('game-over-screen').classList.remove('hidden');
    } else {
        setTimeout(() => { 
            if(gameState === 'PLAYING') {
                player.visible = true; player.x = canvas.width/2; player.y = canvas.height/2; player.vx=0; player.vy=0; 
            }
        }, 2000);
    }
}

// Keyboard Listeners
window.addEventListener('keydown', e => {
    if(e.key === 'ArrowRight' && gameState === 'PLAYING' && player) player.shoot();
    if(e.key === 'Shift' && player) player.hyperspace();
    if(e.key === ' ') isPaused = !isPaused;
    if(keys.hasOwnProperty(e.key)) keys[e.key] = true;
});
window.addEventListener('keyup', e => {
    if(keys.hasOwnProperty(e.key)) keys[e.key] = false;
});

</script>
</body>
</html>